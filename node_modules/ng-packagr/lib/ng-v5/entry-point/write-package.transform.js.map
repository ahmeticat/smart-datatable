{"version":3,"file":"write-package.transform.js","sourceRoot":"","sources":["../../../../src/lib/ng-v5/entry-point/write-package.transform.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs-extra';\nimport * as path from 'path';\nimport { Transform, transformFromPromise } from '../../brocc/transform';\nimport { NgEntryPoint } from '../../ng-package-format/entry-point';\nimport { NgPackage } from '../../ng-package-format/package';\nimport { ensureUnixPath } from '../../util/path';\nimport { rimraf } from '../../util/rimraf';\nimport * as log from '../../util/log';\nimport { globFiles } from '../../util/glob';\nimport { EntryPointNode, isEntryPointInProgress } from '../nodes';\nimport { copyFile } from '../../util/copy';\n\nexport const writePackageTransform: Transform = transformFromPromise(async graph => {\n  const entryPoint = graph.find(isEntryPointInProgress()) as EntryPointNode;\n  const ngEntryPoint: NgEntryPoint = entryPoint.data.entryPoint;\n  const ngPackage: NgPackage = graph.find(node => node.type === 'application/ng-package').data;\n  const { destinationFiles } = entryPoint.data;\n\n  // 5. COPY SOURCE FILES TO DESTINATION\n  log.info('Copying declaration files');\n  // we don't want to copy `dist` and 'node_modules' declaration files but only files in source\n  const declarationFiles = await globFiles(`${path.dirname(ngEntryPoint.entryFilePath)}/**/*.d.ts`, {\n    ignore: ['**/node_modules/**', `${ngPackage.dest}/**`],\n  });\n\n  if (declarationFiles.length) {\n    await Promise.all(\n      declarationFiles.map(value => {\n        const relativePath = path.relative(ngEntryPoint.entryFilePath, value);\n        const destination = path.resolve(destinationFiles.declarations, relativePath);\n        return copyFile(value, destination);\n      }),\n    );\n  }\n\n  // 6. WRITE PACKAGE.JSON\n  log.info('Writing package metadata');\n  const relativeUnixFromDestPath = (filePath: string) =>\n    ensureUnixPath(path.relative(ngEntryPoint.destinationPath, filePath));\n\n  const isIvy = !!entryPoint.data.tsConfig.options.enableIvy;\n\n  await writePackageJson(\n    ngEntryPoint,\n    ngPackage,\n    {\n      main: relativeUnixFromDestPath(destinationFiles.umd),\n      module: relativeUnixFromDestPath(destinationFiles.fesm5),\n      es2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n      esm5: relativeUnixFromDestPath(destinationFiles.esm5),\n      esm2015: relativeUnixFromDestPath(destinationFiles.esm2015),\n      fesm5: relativeUnixFromDestPath(destinationFiles.fesm5),\n      fesm2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n      typings: relativeUnixFromDestPath(destinationFiles.declarations),\n      // Ivy doesn't generate metadata files\n      metadata: isIvy ? undefined : relativeUnixFromDestPath(destinationFiles.metadata),\n      // webpack v4+ specific flag to enable advanced optimizations and code splitting\n      sideEffects: ngEntryPoint.sideEffects,\n    },\n    isIvy,\n  );\n\n  log.success(`Built ${ngEntryPoint.moduleId}`);\n\n  return graph;\n});\n\n/**\n * Creates and writes a `package.json` file of the entry point used by the `node_module`\n * resolution strategies.\n *\n * #### Example\n *\n * A consumer of the entry point depends on it by `import {..} from '@my/module/id';`.\n * The module id `@my/module/id` will be resolved to the `package.json` file that is written by\n * this build step.\n * The properties `main`, `module`, `typings` (and so on) in the `package.json` point to the\n * flattened JavaScript bundles, type definitions, (...).\n *\n * @param entryPoint An entry point of an Angular package / library\n * @param additionalProperties Additional properties, e.g. binary artefacts (bundle files), to merge into `package.json`\n */\nasync function writePackageJson(\n  entryPoint: NgEntryPoint,\n  pkg: NgPackage,\n  additionalProperties: { [key: string]: string | boolean | string[] },\n  isIvy: boolean,\n): Promise<void> {\n  log.debug('Writing package.json');\n\n  // set additional properties\n  const packageJson = { ...entryPoint.packageJson, ...additionalProperties };\n\n  // read tslib version from `@angular/compiler` so that our tslib\n  // version at least matches that of angular if we use require('tslib').version\n  // it will get what installed and not the minimum version nor if it is a `~` or `^`\n  // this is only required for primary\n  if (!entryPoint.isSecondaryEntryPoint && !(packageJson.dependencies && packageJson.dependencies.tslib)) {\n    const { dependencies: angularDependencies = {} } = require('@angular/compiler/package.json');\n    const tsLibVersion = angularDependencies.tslib;\n\n    if (tsLibVersion) {\n      packageJson.dependencies = {\n        ...packageJson.dependencies,\n        tslib: tsLibVersion,\n      };\n    }\n  }\n\n  // Verify non-peerDependencies as they can easily lead to duplicate installs or version conflicts\n  // in the node_modules folder of an application\n  const whitelist = pkg.whitelistedNonPeerDependencies.map(value => new RegExp(value));\n  try {\n    checkNonPeerDependencies(packageJson, 'dependencies', whitelist);\n  } catch (e) {\n    await rimraf(entryPoint.destinationPath);\n    throw e;\n  }\n\n  // Removes scripts from package.json after build\n  if (packageJson.scripts) {\n    if (pkg.keepLifecycleScripts !== true) {\n      log.info(`Removing scripts section in package.json as it's considered a potential security vulnerability.`);\n      delete packageJson.scripts;\n    } else {\n      log.warn(\n        `You enabled keepLifecycleScripts explicitly. The scripts section in package.json will be published to npm.`,\n      );\n    }\n  }\n\n  if (isIvy && !entryPoint.isSecondaryEntryPoint) {\n    const scripts = packageJson.scripts || (packageJson.scripts = {});\n    scripts.prepublishOnly =\n      'node --eval \"console.error(\\'' +\n      'ERROR: Trying to publish a package that has been compiled by Ivy. This is not allowed.\\\\n' +\n      'Please delete and rebuild the package, without compiling with Ivy, before attempting to publish.\\\\n' +\n      '\\')\" ' +\n      '&& exit 1';\n  }\n\n  // keep the dist package.json clean\n  // this will not throw if ngPackage field does not exist\n  delete packageJson.ngPackage;\n  packageJson.name = entryPoint.moduleId;\n\n  // `outputJson()` creates intermediate directories, if they do not exist\n  // -- https://github.com/jprichardson/node-fs-extra/blob/master/docs/outputJson.md\n  await fs.outputJson(path.join(entryPoint.destinationPath, 'package.json'), packageJson, {\n    spaces: 2,\n  });\n}\n\nfunction checkNonPeerDependencies(packageJson: { [key: string]: any }, property: string, whitelist: RegExp[]) {\n  if (packageJson[property]) {\n    Object.keys(packageJson[property]).forEach(dep => {\n      if (whitelist.find(regex => regex.test(dep))) {\n        log.debug(`Dependency ${dep} is whitelisted in '${property}'`);\n      } else {\n        log.warn(\n          `Distributing npm packages with '${property}' is not recommended. Please consider adding ${dep} to 'peerDependencies' or remove it from '${property}'.`,\n        );\n        throw new Error(`Dependency ${dep} must be explicitly whitelisted.`);\n      }\n    });\n  }\n}\n"]}